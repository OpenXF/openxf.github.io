---
aliases:
  - "–∏—Å–∫–ª—é—á–µ–Ω–∏—è RISC-V"
  - "–Ω–µ–ª–µ–≥–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ RISCV"
tags:
  - "#riscv #–∏—Å–∫–ª—é—á–µ–Ω–∏—è #–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"
path:
  - "architecture/riscv/privileged"
---

## üìå –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ª–µ–≥–∞–ª—å–Ω—ã—Ö –∏ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ [[RISC-V]]

–í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ [[RISC-V]] –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞ —á—ë—Ç–∫–∞—è –º–æ–¥–µ–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π, –≤–∫–ª—é—á–∞—è —Å–ª—É—á–∞–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è **–Ω–µ–ª–µ–≥–∞–ª—å–Ω—ã—Ö** –∏–ª–∏ **–Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö** –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –≠—Ç–æ –≤–∞–∂–Ω–æ –∫–∞–∫ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —è–¥—Ä–∞, —Ç–∞–∫ –∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

- –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (–Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ [[ISA]]),
- –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –Ω–µ –≤–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –≤ –¥–∞–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `F`, `D`, `C`),
- –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é,

—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç **trap (–∏—Å–∫–ª—é—á–µ–Ω–∏–µ)** —Ç–∏–ø–∞ **Illegal Instruction**.

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã:

| –†–µ–≥–∏—Å—Ç—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `mcause` | –ø—Ä–∏—á–∏–Ω–∞ trap‚Äô–∞ (`mcause = 2` –¥–ª—è Illegal Instruction) |
| `mepc`   | –∞–¥—Ä–µ—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –≤—ã–∑–≤–∞–≤—à–µ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ |
| `mtval`  | —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥ –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–ª—å) |
| `mtvec`  | –∞–¥—Ä–µ—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π |

---

### –ü—Ä–∏–º–µ—Ä: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ä–µ–∂–∏–º–µ Machine

```c
// –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ mtvec
void handle_trap() {
    uintptr_t cause = read_csr(mcause);
    if (cause == 2) {
        uintptr_t inst = read_csr(mtval);
        uintptr_t epc = read_csr(mepc);
        printf("Illegal instruction 0x%lx at PC=0x%lx\n", inst, epc);
        // –≤–æ–∑–º–æ–∂–Ω–æ: –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å, —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å
    }
}
````

---

## ‚öôÔ∏è –ì–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

- –í –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –Ω–∞ [[RISC-V]], –Ω–∞–ø—Ä–∏–º–µ—Ä [[Linux Kernel]], –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ `SIGILL`
    
- –í –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–∞—Ö –∏ —ç–º—É–ª—è—Ç–æ—Ä–∞—Ö ‚Äî –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ fallback –∏–ª–∏ —ç–º—É–ª—è—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
    
- –í –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —è–¥—Ä–∞—Ö ‚Äî –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ soft-float, soft-MMU –∏ —Ç.–ø.
    

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è trap-–º–µ—Ö–∞–Ω–∏–∑–º–∞, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–Ω–∞—è —á–µ—Ä–µ–∑ [[Privileged ISA]]
    
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–º—É–ª—è—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ trap + software fallback)
    
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–µ–ª–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
    

---

## ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

- –û–±—Ä–∞–±–æ—Ç–∫–∞ trap‚Äô–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Ä–æ–≥–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (context switch)
    
- –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã firmware –∏–ª–∏ –û–°
    
