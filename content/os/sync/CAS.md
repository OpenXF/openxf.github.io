---
aliases:
  - "CAS"
  - "Compare-And-Swap"
  - "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –∑–∞–º–µ–Ω–∞"
tags:
  - "#cpu #atomic #concurrency"
path:
  - "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ/–æ—Å/—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è"
---

## üìå CAS  
CAS (Compare-And-Swap) ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ø—Ä–∏–º–µ–Ω—è–µ–º–∞—è –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö —Å—Ä–µ–¥–∞—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è [[Lock]] –∏–ª–∏ [[Mutex]]. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö [[Spinlock]], lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç  
CAS –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç—Ä–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞:

1. **–ê–¥—Ä–µ—Å** (memory location)  
2. **–û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**  
3. **–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**

CAS —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É —Å –æ–∂–∏–¥–∞–µ–º—ã–º, –∏ –µ—Å–ª–∏ –æ–Ω–∏ —Ä–∞–≤–Ω—ã ‚Äî **–∑–∞–º–µ–Ω—è–µ—Ç –µ–≥–æ –Ω–∞ –Ω–æ–≤–æ–µ**. –í—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ.

```c
// –ü—Å–µ–≤–¥–æ–∫–æ–¥
bool CAS(addr, expected, new) {
    if (*addr == expected) {
        *addr = new;
        return true;
    } else {
        return false;
    }
}
````

–ù–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–º —É—Ä–æ–≤–Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑:

- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç–∏–ø–∞ `CMPXCHG` (x86), `LDREX/STREX` (ARM)
    
- [[root/CPU/CPU]]-–ø–æ–¥–¥–µ—Ä–∂–∫—É –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ [[Memory barrier]]
    

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

- Lock-free –æ—á–µ—Ä–µ–¥–µ–π –∏ —Å—Ç–µ–∫–æ–≤
    
- [[Spinlock]] –∏ [[Atomic]] –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    
- [[Reference counting]] –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    

## ‚öôÔ∏è –ì–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

|–û–±–ª–∞—Å—Ç—å|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|
|[[Multicore CPU]]|–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ–±—â–µ–π –ø–∞–º—è—Ç–∏|
|[[RTOS]]|–†–µ–∞–ª–∏–∑–∞—Ü–∏—è fast-path –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫|
|[[Kernel]]|–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, [[TCB]]|
|[[User-space library]]|–†–µ–∞–ª–∏–∑–∞—Ü–∏—è [[Mutex]], [[Semaphore]], [[Queue]]|

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
    
- –û—Å–Ω–æ–≤–∞ –¥–ª—è lock-free –∏ wait-free –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
    

## ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

- –¢—Ä–µ–±—É–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
    
- [[ABA problem]] ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è
    
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π