---
aliases:
  - "Memory Map"
  - "mmap"
  - "–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏"
tags:
  - "#os #linux #memory #syscall"
path:
  - "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ/–æ—Å/–ø–∞–º—è—Ç—å"
---

## üìå Memory Map [[mmap]]  
Memory Map [[mmap]] ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ –∫–∞–∫ —Å –º–∞—Å—Å–∏–≤–∞–º–∏ –≤ –ø–∞–º—è—Ç–∏, –º–∏–Ω—É—è –≤—ã–∑–æ–≤—ã [[read()]]/[[write()]].

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç  
–°–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `mmap()` –≤—ã–¥–µ–ª—è–µ—Ç —É—á–∞—Å—Ç–æ–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å —Ñ–∞–π–ª–æ–º –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º. –î–æ—Å—Ç—É–ø –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Ñ–∞–π–ª–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é (—É–∫–∞–∑–∞—Ç–µ–ª–∏).

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏:

- `MAP_SHARED` / `MAP_PRIVATE` ‚Äî –æ–±—â–∏–π/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø  
- `PROT_READ`, `PROT_WRITE`, `PROT_EXEC` ‚Äî –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞  
- `MAP_ANONYMOUS` ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ —Ñ–∞–π–ª–∞ (–æ–±—ã—á–Ω–æ –¥–ª—è [[malloc]])  
- `MAP_LOCKED` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ [[RAM]] (–±–µ–∑ —Å–≤–æ–ø–∞)  
- `MAP_HUGETLB` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ [[HugePages]]

–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑:

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞  
2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ñ–∞–π–ª—É (inode)  
3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ [[Page Table]] –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ (Page Fault)  
4. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è (—á–µ—Ä–µ–∑ `msync()` –∏–ª–∏ –ø—Ä–∏ `munmap()`)

## ‚öôÔ∏è –ì–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

| –ö–æ–Ω—Ç–µ–∫—Å—Ç              | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ                               |
| --------------------- | ---------------------------------------- |
| [[Shared Memory]]     | –ú–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (IPC)       |
| [[File IO]]           | –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤         |
| [[Executable Loader]] | –ó–∞–≥—Ä—É–∑–∫–∞ ELF, —Å–µ–∫—Ü–∏–∏ .text/.data/.bss    |
| [[Dynamic Linking]]   | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ .so-–±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ –ø–∞–º—è—Ç—å       |
| [[JIT\|JIT Compiler]] | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è       |
| [[Kernel]]            | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ `vm_area` |

## üíª –ü—Ä–∏–º–µ—Ä (C, mmap —Ñ–∞–π–ª–∞)

```c
#include <sys/mman.h>
#include <fcntl.h>
#include <unistd.h>

int fd = open("data.bin", O_RDONLY);
char *map = mmap(NULL, 4096, PROT_READ, MAP_PRIVATE, fd, 0);
// –¢–µ–ø–µ—Ä—å map[0] —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∞–π—Ç –∏–∑ —Ñ–∞–π–ª–∞
munmap(map, 4096);
close(fd);
````

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ [[Syscall]])
    
- –û–±—â–∞—è –ø–∞–º—è—Ç—å –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    
- –£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∫–∞–∫ —Å –º–∞—Å—Å–∏–≤–∞–º–∏
    

## ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤)
    
- –û—à–∏–±–∫–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ [[Segfault]]
    
- –¢—Ä–µ–±—É–µ—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∏ —É—á—ë—Ç–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    
- –ù–µ –≤—Å–µ–≥–¥–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö